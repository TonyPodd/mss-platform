#!/bin/bash

# –î–µ–ø–ª–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è MSS –ø—Ä–æ–µ–∫—Ç–∞
echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/mss-platform

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop mss-web mss-admin mss-api

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì• –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ GitHub..."
git fetch origin
git reset --hard origin/main

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pnpm install

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client
echo "üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client..."
pnpm --filter api exec npx prisma generate

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
pnpm --filter api exec npx prisma migrate deploy

# –°–æ–±–∏—Ä–∞–µ–º –æ–±—â–∏–µ –ø–∞–∫–µ—Ç—ã
echo "üî® –°–æ–±–∏—Ä–∞–µ–º Shared..."
pnpm --filter @mss/shared build

echo "üî® –°–æ–±–∏—Ä–∞–µ–º API Client..."
pnpm --filter @mss/api-client build

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üî® –°–æ–±–∏—Ä–∞–µ–º API..."
pnpm --filter api build

echo "üî® –°–æ–±–∏—Ä–∞–µ–º Web..."
pnpm --filter web build

echo "üî® –°–æ–±–∏—Ä–∞–µ–º Admin..."
pnpm --filter admin build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart mss-api mss-web mss-admin

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
pm2 status
